<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>マイ実績</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 16px; background:#f9fafb; color:#111827; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:20px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.05); }
    .title { font-weight:700; font-size:16px; margin-bottom:12px; color:#374151; }
    input.code { width:100%; box-sizing:border-box; padding:14px; border:1px solid #d1d5db; border-radius:12px; font-size:18px; letter-spacing:.05em; text-align:center; background:#f9fafb; outline:none; }
    input[readonly] { background:#f3f4f6; color:#6b7280; cursor:pointer; }
    .btn-row { display:flex; gap:10px; margin-top:12px; }
    button { flex:1; padding:12px; border-radius:12px; border:none; font-weight:600; cursor:pointer; font-size:14px; }
    .btn-primary { background:#111827; color:#fff; }
    .btn-outline { background:transparent; border:1px solid #d1d5db; color:#374151; }
    .stats-row { display:flex; justify-content:space-around; text-align:center; margin-top:8px; }
    .stat-label { font-size:12px; color:#6b7280; margin-bottom:4px; display:block; }
    .stat-val { font-size:24px; font-weight:800; color:#111827; }
    #msg { margin-top:12px; font-size:13px; color:#059669; font-weight:600; text-align:center; min-height:20px; }
    .loader { text-align:center; color:#9ca3af; font-size:14px; margin-top:20px; word-break:break-word; white-space:pre-wrap; }
    #inviter-card { display:none; }
    .build { font-size:12px; color:#9ca3af; text-align:right; margin-top:-8px; margin-bottom:8px; }
  </style>
</head>
<body>

  <div class="build" id="build"></div>

  <div class="card">
    <div class="title">あなたの招待コード</div>
    <input id="myCode" class="code" readonly value="..." />
    <div class="btn-row">
      <button class="btn-primary" id="btnCopy">コードをコピー</button>
      <button class="btn-outline" id="btnReload">更新</button>
    </div>
    <div id="msg"></div>
  </div>

  <div class="card">
    <div class="title">招待実績</div>
    <div class="stats-row">
      <div>
        <span class="stat-label">直接招待 (L1)</span>
        <span class="stat-val" id="l1">-</span>
      </div>
      <div>
        <span class="stat-label">間接招待 (L2)</span>
        <span class="stat-val" id="l2">-</span>
      </div>
    </div>
  </div>

  <div class="card" id="inviter-card">
    <div class="title">紹介者のコードを入力</div>
    <div style="font-size:12px; color:#6b7280; margin-bottom:8px;">紹介コードを入力すると、招待ツリーに登録されます。</div>
    <input id="invCode" class="code" placeholder="例：HSH..." />
    <div class="btn-row">
      <button class="btn-primary" id="btnSubmit">登録する</button>
    </div>
  </div>

  <div class="loader" id="status">読み込み中...</div>

<script>
(() => {
  'use strict';

  const BUILD = '2025-12-26-05';
  const LIFF_ID = '2008677807-KWMkUjoS';

  // ★ここ超重要：LINE Developersで設定した「LIFF Endpoint URL」と同じURL（配下でもOK）にする
  // 例）https://yourname.github.io/yourrepo/  ← 末尾スラッシュ推奨
  const ENDPOINT_URL = 'https://tt0301t-dev.github.io/my-liff/';

  // GASのexec（APIとしてだけ使う）
  const EXEC_URL = 'https://script.google.com/macros/s/AKfycbwwPhr6LjgnxsKMzJTUc3mN6HIRHewl24kGh0eLvfKs6UlT2lAbxjxl5ZoASVfs9ydzEQ/exec';

  let currentUserId = null;
  const $ = (id) => document.getElementById(id);

  function setStatus(msg) { $('status').style.display='block'; $('status').textContent = msg; }
  function hideStatus() { $('status').style.display='none'; }
  function flashMsg(msg){ $('msg').textContent = msg; setTimeout(()=> $('msg').textContent='', 2000); }

  // 画面で死因を見える化（LINE内はコンソール見づらいので）
  window.addEventListener('error', (e) => setStatus('JS ERROR: ' + (e?.message || e)));
  window.addEventListener('unhandledrejection', (e) => setStatus('PROMISE ERROR: ' + (e?.reason?.message || e.reason || e)));

  const timeout = (ms) => new Promise((_, rej) => setTimeout(() => rej(new Error('timeout ' + ms + 'ms')), ms));

  // JSONPでGASを呼ぶ（CORS回避）
  function callApi(fn, payload) {
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Date.now() + '_' + Math.random().toString(36).slice(2);
      const script = document.createElement('script');

      const q = new URLSearchParams({ api:'1', fn, callback: cb });
      Object.entries(payload || {}).forEach(([k,v]) => q.set(k, v));

      const timer = setTimeout(() => cleanup(new Error('API timeout')), 15000);

      window[cb] = (data) => cleanup(null, data);

      function cleanup(err, data) {
        clearTimeout(timer);
        try { delete window[cb]; } catch(e) {}
        if (script.parentNode) script.parentNode.removeChild(script);
        if (err) reject(err); else resolve(data);
      }

      script.onerror = () => cleanup(new Error('API load error'));
      script.src = EXEC_URL + '?' + q.toString();
      document.head.appendChild(script);
    });
  }

  function onDataLoaded(res){
    if (!res || !res.ok) { setStatus('取得失敗: ' + (res?.message || '不明')); return; }
    hideStatus();
    $('myCode').value = res.my_code || '(no code)';
    $('l1').textContent = (res.l1 ?? '-');
    $('l2').textContent = (res.l2 ?? '-');
    if (!res.invited_by) $('inviter-card').style.display = 'block';
  }

  async function main(){
    try{
      // まず「いまどのURLで動いてるか」を必ず出す
      setStatus(
        '起動情報\n' +
        'href: ' + location.href + '\n' +
        'iframe: ' + (window.top !== window.self) + '\n' +
        'sdk: ' + (typeof liff !== 'undefined')
      );

      // Endpointと現在URLがズレると init が保証されない（＝止まりやすい） :contentReference[oaicite:4]{index=4}
      if (ENDPOINT_URL && !location.href.startsWith(ENDPOINT_URL)) {
        setStatus(
          '⚠ Endpoint不一致の可能性\n' +
          'current: ' + location.href + '\n' +
          'endpoint: ' + ENDPOINT_URL + '\n\n' +
          '→ LINE Developers の LIFF Endpoint URL をこのページのURL（または上位パス）に合わせてください。'
        );
        return;
      }

      setStatus('LIFF初期化中…');

      // 外部ブラウザでもログインを自動実行できるオプション :contentReference[oaicite:5]{index=5}
      await Promise.race([
        liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true }),
        timeout(8000)
      ]);

      setStatus('LIFF init OK\nisInClient=' + liff.isInClient() + '\nisLoggedIn=' + liff.isLoggedIn());

      // 注意：LIFFブラウザ(=LINE内)は init 時にログインが走るので、基本ここで true になる :contentReference[oaicite:6]{index=6}
      if (!liff.isLoggedIn()) {
        if (liff.isInClient()) {
          setStatus('LINE内なのに未ログイン判定です。Endpoint/Scope/公開設定を再確認してください。');
          return;
        }
        setStatus('外部ブラウザ：ログインへ遷移します…');
        liff.login(); // redirectUriは基本任せる（変に付けるとループしがち）
        return;
      }

      setStatus('プロフィール取得中…');
      const profile = await Promise.race([liff.getProfile(), timeout(8000)]);
      currentUserId = profile.userId;

      setStatus('実績取得中…\nuserId=' + currentUserId);
      const res = await callApi('getOrCreateUser', { lineUserId: currentUserId });
      onDataLoaded(res);

    } catch(e){
      setStatus('エラー: ' + (e?.message || String(e)));
      console.log(e);
    }
  }

  async function submitInviter(){
    const code = $('invCode').value.trim();
    if (!code) return alert('コードを入力してください');
    if (!currentUserId) return alert('ユーザー情報が取れていません');

    if (!confirm('紹介コード: ' + code + '\n登録しますか？（後から変更できません）')) return;

    setStatus('登録中…');
    try{
      const res = await callApi('saveInviter', { lineUserId: currentUserId, code });
      if (res?.ok) {
        alert(res.message || '登録しました');
        hideStatus();
        $('inviter-card').style.display = 'none';
        $('l1').textContent = (res.l1 ?? $('l1').textContent);
        $('l2').textContent = (res.l2 ?? $('l2').textContent);
      } else {
        setStatus('エラー: ' + (res?.message || '不明'));
      }
    } catch(e){
      setStatus('通信エラー: ' + (e?.message || String(e)));
    }
  }

  async function copyText(){
    const input = $('myCode');
    const text = input.value || '';
    try{
      await navigator.clipboard.writeText(text);
      flashMsg('コピーしました！');
    } catch(e){
      alert('コピーに失敗しました。長押しでコピーしてください。');
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    $('build').textContent = 'build: ' + BUILD;
    $('btnCopy').addEventListener('click', copyText);
    $('myCode').addEventListener('click', copyText);
    $('btnSubmit').addEventListener('click', submitInviter);
    $('btnReload').addEventListener('click', () => location.reload());
    main();
  });
})();
</script>
</body>
</html>
