<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>マイ実績</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 16px; background:#f9fafb; color:#111827; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:20px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.05); }
    .title { font-weight:700; font-size:16px; margin-bottom:12px; color:#374151; }
    input.code { width:100%; box-sizing:border-box; padding:14px; border:1px solid #d1d5db; border-radius:12px; font-size:18px; letter-spacing:.05em; text-align:center; background:#f9fafb; outline:none; }
    input[readonly] { background:#f3f4f6; color:#6b7280; cursor:pointer; }
    .btn-row { display:flex; gap:10px; margin-top:12px; }
    button { flex:1; padding:12px; border-radius:12px; border:none; font-weight:600; cursor:pointer; font-size:14px; }
    .btn-primary { background:#111827; color:#fff; }
    .btn-outline { background:transparent; border:1px solid #d1d5db; color:#374151; }
    .stats-row { display:flex; justify-content:space-around; text-align:center; margin-top:8px; }
    .stat-label { font-size:12px; color:#6b7280; margin-bottom:4px; display:block; }
    .stat-val { font-size:24px; font-weight:800; color:#111827; }
    #msg { margin-top:12px; font-size:13px; color:#059669; font-weight:600; text-align:center; min-height:20px; }
    .loader { text-align:center; color:#9ca3af; font-size:14px; margin-top:20px; word-break:break-word; white-space:pre-wrap; }
    #inviter-card { display:none; }
    .build { font-size:12px; color:#9ca3af; text-align:right; margin-top:-8px; margin-bottom:8px; }

    .list-item { padding:10px 0; border-top:1px solid #e5e7eb; }
    .list-name { font-weight:800; color:#111827; }
    .list-sub { font-size:12px; color:#6b7280; margin-top:2px; }
    .pill { display:inline-block; font-size:11px; padding:3px 8px; border-radius:999px; background:#f3f4f6; color:#374151; margin-left:6px; }
  </style>
</head>
<body>

  <div class="build" id="build"></div>

  <!-- ✅ ここを一番上に移動（未登録ユーザーだけ表示） -->
  <div class="card" id="inviter-card">
    <div class="title">紹介者のコードを入力</div>
    <div style="font-size:12px; color:#6b7280; margin-bottom:8px; font-weight:700;">
      紹介者から送られた招待コードを入力して下さい
    </div>
    <div style="font-size:12px; color:#6b7280; margin-bottom:8px;">
      紹介コードを入力すると、招待ツリーに登録されます。（※後から変更できません）
    </div>
    <input id="invCode" class="code" placeholder="例：HSH..." />
    <div class="btn-row">
      <button class="btn-primary" id="btnSubmit">登録する</button>
    </div>
  </div>

  <div class="card">
    <div class="title">あなたの招待コード</div>
    <input id="myCode" class="code" readonly value="..." />
    <div class="btn-row">
      <button class="btn-primary" id="btnCopy">コードをコピー</button>
      <button class="btn-outline" id="btnReload">更新</button>
    </div>
    <div id="msg"></div>
  </div>

  <div class="card">
    <div class="title">招待実績</div>
    <div class="stats-row">
      <div>
        <span class="stat-label">直接招待 (L1)</span>
        <span class="stat-val" id="l1">-</span>
      </div>
      <div>
        <span class="stat-label">間接招待 (L2)</span>
        <span class="stat-val" id="l2">-</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="title">あなたが紹介した人（L1一覧） <span class="pill" id="l1Count">0</span></div>
    <div id="l1List" class="loader">読み込み中...</div>
  </div>

  <div class="card">
    <div class="title">あなたの紹介の紹介（L2一覧） <span class="pill" id="l2Count">0</span></div>
    <div style="font-size:12px; color:#6b7280; margin-bottom:8px;">※「誰（L1）が紹介したか」も表示します。</div>
    <div id="l2List" class="loader">読み込み中...</div>
  </div>

  <div class="loader" id="status">読み込み中...</div>

<script>
(() => {
  'use strict';

  const BUILD = '2026-01-02-02'; // ★更新したらここを変えるとキャッシュ判別しやすい
  const LIFF_ID = '2008677807-KWMkUjoS';
  const ENDPOINT_URL = 'https://tt0301t-dev.github.io/my-liff/';
  const EXEC_URL = 'https://script.google.com/macros/s/AKfycbwwPhr6LjgnxsKMzJTUc3mN6HIRHewl24kGh0eLvfKs6UlT2lAbxjxl5ZoASVfs9ydzEQ/exec';

  let currentUserId = null;
  let currentProfile = null;

  const $ = (id) => document.getElementById(id);

  function setStatus(msg) { $('status').style.display='block'; $('status').textContent = msg; }
  function hideStatus() { $('status').style.display='none'; }
  function flashMsg(msg){ $('msg').textContent = msg; setTimeout(()=> $('msg').textContent='', 2000); }

  window.addEventListener('error', (e) => setStatus('JS ERROR: ' + (e?.message || e)));
  window.addEventListener('unhandledrejection', (e) => setStatus('PROMISE ERROR: ' + (e?.reason?.message || e.reason || e)));

  const timeout = (ms) => new Promise((_, rej) => setTimeout(() => rej(new Error('timeout ' + ms + 'ms')), ms));

  function callApi(fn, payload) {
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Date.now() + '_' + Math.random().toString(36).slice(2);
      const script = document.createElement('script');

      const q = new URLSearchParams({ api:'1', fn, callback: cb });
      Object.entries(payload || {}).forEach(([k,v]) => q.set(k, v));

      const timer = setTimeout(() => cleanup(new Error('API timeout')), 15000);

      window[cb] = (data) => cleanup(null, data);

      function cleanup(err, data) {
        clearTimeout(timer);
        try { delete window[cb]; } catch(e) {}
        if (script.parentNode) script.parentNode.removeChild(script);
        if (err) reject(err); else resolve(data);
      }

      script.onerror = () => cleanup(new Error('API load error'));
      script.src = EXEC_URL + '?' + q.toString();
      document.head.appendChild(script);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }

  function renderList(elId, list, emptyMsg, isL2){
    const el = $(elId);
    if (!list || !list.length) { el.textContent = emptyMsg; return; }

    el.innerHTML = list.map(x => {
      const name = escapeHtml(x.name || '（未取得）');
      const sub  = escapeHtml((x.joinedAt || '') + (x.code ? (' / ' + x.code) : ''));
      const via  = isL2 ? `<div class="list-sub">紹介者：${escapeHtml(x.viaName || '（未取得）')}${x.viaCode ? ' / '+escapeHtml(x.viaCode) : ''}</div>` : '';
      return `
        <div class="list-item">
          <div class="list-name">${name}</div>
          <div class="list-sub">${sub}</div>
          ${via}
        </div>
      `;
    }).join('');
  }

  async function loadTree(){
    try{
      $('l1List').textContent = '読み込み中...';
      $('l2List').textContent = '読み込み中...';
      const r = await callApi('getInviteTree', { lineUserId: currentUserId });
      if (!r?.ok) {
        $('l1List').textContent = '取得失敗: ' + (r?.message || '不明');
        $('l2List').textContent = '取得失敗: ' + (r?.message || '不明');
        return;
      }
      $('l1Count').textContent = String(r.l1_total ?? (r.l1?.length || 0));
      $('l2Count').textContent = String(r.l2_total ?? (r.l2?.length || 0));

      renderList('l1List', r.l1, 'まだL1紹介はありません', false);
      renderList('l2List', r.l2, 'まだL2紹介はありません', true);
    } catch(e){
      $('l1List').textContent = '通信エラー: ' + (e?.message || String(e));
      $('l2List').textContent = '通信エラー: ' + (e?.message || String(e));
    }
  }

  function onDataLoaded(res){
    if (!res || !res.ok) { setStatus('取得失敗: ' + (res?.message || '不明')); return; }
    hideStatus();
    $('myCode').value = res.my_code || '(no code)';
    $('l1').textContent = (res.l1 ?? '-');
    $('l2').textContent = (res.l2 ?? '-');
    if (!res.invited_by) $('inviter-card').style.display = 'block';
  }

  async function main(){
    try{
      setStatus(
        '起動情報\n' +
        'href: ' + location.href + '\n' +
        'iframe: ' + (window.top !== window.self) + '\n' +
        'sdk: ' + (typeof liff !== 'undefined')
      );

      if (ENDPOINT_URL && !location.href.startsWith(ENDPOINT_URL)) {
        setStatus(
          '⚠ Endpoint不一致の可能性\n' +
          'current: ' + location.href + '\n' +
          'endpoint: ' + ENDPOINT_URL + '\n\n' +
          '→ LINE Developers の LIFF Endpoint URL を github.io のURL（または上位パス）に合わせてください。'
        );
        return;
      }

      setStatus('LIFF初期化中…');
      await Promise.race([
        liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true }),
        timeout(8000)
      ]);

      setStatus('LIFF init OK\nisInClient=' + liff.isInClient() + '\nisLoggedIn=' + liff.isLoggedIn());

      if (!liff.isLoggedIn()) {
        if (liff.isInClient()) {
          setStatus('LINE内なのに未ログイン判定です。Endpoint/Scope/公開設定を再確認してください。');
          return;
        }
        setStatus('外部ブラウザ：ログインへ遷移します…');
        liff.login();
        return;
      }

      setStatus('プロフィール取得中…');
      currentProfile = await Promise.race([liff.getProfile(), timeout(8000)]);
      currentUserId = currentProfile.userId;

      setStatus('実績取得中…\nuserId=' + currentUserId);
      const res = await callApi('getOrCreateUser', {
        lineUserId: currentUserId,
        displayName: currentProfile.displayName || '',
        pictureUrl: currentProfile.pictureUrl || ''
      });

      onDataLoaded(res);
      loadTree();

    } catch(e){
      setStatus('エラー: ' + (e?.message || String(e)));
      console.log(e);
    }
  }

  async function submitInviter(){
    const code = $('invCode').value.trim();
    if (!code) return alert('コードを入力してください');
    if (!currentUserId) return alert('ユーザー情報が取れていません');

    if (!confirm('紹介コード: ' + code + '\n登録しますか？（後から変更できません）')) return;

    setStatus('登録中…');
    try{
      if (!currentProfile) currentProfile = await Promise.race([liff.getProfile(), timeout(8000)]);

      const res = await callApi('saveInviter', {
        lineUserId: currentUserId,
        code,
        displayName: currentProfile.displayName || '',
        pictureUrl: currentProfile.pictureUrl || ''
      });

      if (res?.ok) {
        alert(res.message || '登録しました');
        hideStatus();
        $('inviter-card').style.display = 'none';
        $('l1').textContent = (res.l1 ?? $('l1').textContent);
        $('l2').textContent = (res.l2 ?? $('l2').textContent);
        loadTree();
      } else {
        setStatus('エラー: ' + (res?.message || '不明'));
      }
    } catch(e){
      setStatus('通信エラー: ' + (e?.message || String(e)));
    }
  }

  async function copyText(){
    const input = $('myCode');
    const text = input.value || '';
    try{
      await navigator.clipboard.writeText(text);
      flashMsg('コピーしました！');
    } catch(e){
      alert('コピーに失敗しました。長押しでコピーしてください。');
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    $('build').textContent = 'build: ' + BUILD;
    $('btnCopy').addEventListener('click', copyText);
    $('myCode').addEventListener('click', copyText);
    $('btnSubmit').addEventListener('click', submitInviter);
    $('btnReload').addEventListener('click', () => location.reload());
    main();
  });
})();
</script>
</body>
</html>
